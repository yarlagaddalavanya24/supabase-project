name: Run Supabase SQL Migrations

on:
  push:
    paths:
      - 'supabase/migrations/**.sql'
      - '.github/workflows/supabase-migrate.yml'

jobs:
  migrate:
    name: Supabase SQL Migrations
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Install PostgreSQL Client
        run: sudo apt-get install -y postgresql-client

      - name: Force IPv4 preference to avoid Supabase connection issues
        run: |
          echo 'precedence ::ffff:0:0/96  100' | sudo tee -a /etc/gai.conf

      - name: Validate Database Connection
        env:
          PGPASSWORD: ${{ secrets.DDATABASE_PASSWORD }}
        run: |
          echo "Testing connection to DB..."
          psql -h ${{ secrets.DB_HOST }} \
               -p ${{ secrets.DB_PORT }} \
               -U ${{ secrets.DB_USER }} \
               -d ${{ secrets.SUPABASE_DB_NAME }} \
               -c "SELECT NOW();" || { echo "❌ Failed to connect to database"; exit 1; }

      - name: Run Supabase migrations
        env:
          PGPASSWORD: ${{ secrets.DATABASE_PASSWORD }}
        run: |
          for file in supabase/migrations/*.sql; do
            echo "🟡 Running migration: $file"
            psql -h ${{ secrets.DB_HOST }} \
                 -p ${{ secrets.DB_PORT }} \
                 -U ${{ secrets.DB_USER }} \
                 -d ${{ secrets.SUPABASE_DB_NAME }} \
                 -f "$file" || {
              echo "❌ Migration failed: $file"
              exit 1
            }
          done
          echo "✅ All migrations applied successfully."

      - name: Post Status Summary
        if: always()
        run: |
          if [ "$GITHUB_JOB" == "migrate" ]; then
            echo "### ✅ Migration completed successfully" >> $GITHUB_STEP_SUMMARY
          else
            echo "### ❌ Migration failed. Check logs above." >> $GITHUB_STEP_SUMMARY
          fi

